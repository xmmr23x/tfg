\chapter{Código del programa}


\section{Codificación de las categorías \textit{malware}}
\label{sec:codificacion}

\lstset{style=codestyle, language=Python}
\begin{lstlisting}[frame=single]
X, y        = load('bodmas/bodmas.npz')
metadata    = pd.read_csv('bodmas/bodmas_metadata.csv')
mw_category = pd.read_csv('bodmas/bodmas_malware_category.csv')

# Incluimos los valores de 'category' en metadata cuando coinciden los valoes de 'sha'
mw_category = metadata.merge(mw_category, on = 'sha', how = 'left')

# Rellenamos los huecos como software benigno
mw_category['category'] = mw_category['category'].fillna('benign')

# Eliminamos todas las columnas excepto 'category'
mw_category = mw_category['category']

# Codificamos las categorias de malware
category = {
	'benign': 0, 'trojan': 1, 'worm': 2, 'backdoor': 3,
	'downloader': 4, 'informationstealer': 5, 'dropper': 6,
	'ransomware': 7, 'rootkit': 8, 'cryptominer': 9, 'pua': 10,
	'exploit': 11, 'virus': 12, 'p2p-worm': 13, 'trojan-gamethief': 14
}

mw_category = mw_category.map(category)

y = mw_category.to_numpy()

save('bodmas/bodmas_multiclass.npz', X, y)

\end{lstlisting}

\section{Reducción de la dimensionalidad}
\label{sec:red_dim}

\lstset{style=codestyle, language=Python}
\begin{lstlisting}[frame=single]
def resampling(X, y, n_components = 5, size = 15000, u = False):
	if u:
		rus  = RandomUnderSampler(sampling_strategy = {0: size, 1: size})
		# rus  = RandomUnderSampler(sampling_strategy = 'majority')
		X, y = rus.fit_resample(X, y)

	X_train, X_test, y_train, y_test = train_test_split(
		X, y, test_size = 0.25, random_state = 1
	)

	pca     = PCA(n_components)
	X_train = pca.fit_transform(X_train)
	X_test  = pca.transform(X_test)

	return X_train, X_test, y_train, y_test
\end{lstlisting}

\newpage
\section{Pruebas para la elección del conjunto de datos}
\label{sec:select_dataset}

\lstset{style=codestyle, language=Python}
\begin{lstlisting}[frame=single]
file = {'pca_binary', 'resampling_binary', 'pca_multiclass'}
clf  = None

print('clasificador,dataset,n patrones,n caracteristicas,accuracy,tiempo')

for i in range(3):
	if i == 0: clf = DecisionTreeClassifier()
	elif i == 1: clf = RandomForestClassifier()
	else: clf = KNeighborsClassifier()

	for train_file in file:

		X_train, y_train = load('bodmas/' + train_file + '_train.npz')
		X_test, y_test = load('bodmas/' + train_file + '_test.npz')

		# Entrenar el modelo
		inicio = time.time()
		clf.fit(X_train, y_train)
		tiempo = time.time() - inicio

		# Predecir sobre el conjunto de prueba
		y_pred = clf.predict(X_test)

		# Evaluar
		accuracy = accuracy_score(y_test, y_pred)

		print(f'{i},{train_file},{X_train.shape},{accuracy:.3f},{tiempo:.3f}')

\end{lstlisting}
